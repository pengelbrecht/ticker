{
  "blocked_by": [
    "tps"
  ],
  "closed_at": "2026-01-14T17:37:45.965084Z",
  "closed_reason": "Added signalToAwaiting map and handleSignal method to engine.go. Maps all 8 handoff signals to awaiting states (eject→work, blocked→input, approval_needed→approval, etc). COMPLETE signal checks task.Requires before closing. Context passed to SetAwaiting as note. Unknown signals return nil gracefully. Added tests for map completeness and requires field logic.",
  "created_at": "2026-01-14T16:13:58.840247Z",
  "created_by": "peter@engelbrecht.dk",
  "description": "Add handleSignal method to internal/engine/engine.go that maps signals to awaiting states:\n\n```go\n// signalToAwaiting maps signals to their corresponding awaiting states\nvar signalToAwaiting = map[Signal]string{\n    SignalEject:           \"work\",\n    SignalBlocked:         \"input\",  // Legacy\n    SignalApprovalNeeded:  \"approval\",\n    SignalInputNeeded:     \"input\",\n    SignalReviewRequested: \"review\",\n    SignalContentReview:   \"content\",\n    SignalEscalate:        \"escalation\",\n    SignalCheckpoint:      \"checkpoint\",\n}\n\nfunc (e *Engine) handleSignal(task *ticks.Task, signal Signal, context string) error {\n    switch signal {\n    case SignalComplete:\n        // Check for pre-declared approval gate\n        if task.Requires != \"\" {\n            return e.ticks.SetAwaiting(task.ID, task.Requires, \"Work complete, requires \"+task.Requires)\n        }\n        return e.ticks.CloseTask(task.ID, \"Completed by agent\")\n        \n    default:\n        if awaiting, ok := signalToAwaiting[signal]; ok {\n            return e.ticks.SetAwaiting(task.ID, awaiting, context)\n        }\n    }\n    return nil\n}\n```\n\nAcceptance criteria:\n- [ ] All signals mapped to correct awaiting states\n- [ ] COMPLETE checks requires field before closing\n- [ ] Context passed to SetAwaiting as note\n- [ ] Unknown signals handled gracefully",
  "id": "t9y",
  "owner": "peter@engelbrecht.dk",
  "parent": "eso",
  "priority": 0,
  "run": {
    "session_id": "ac769751-8513-4f9d-9881-0467bba29c05",
    "model": "claude-opus-4-5-20251101",
    "started_at": "2026-01-14T18:34:17.880893+01:00",
    "ended_at": "2026-01-14T18:38:22.040506+01:00",
    "output": "I'll start by reviewing the current state of the codebase to understand the existing signal handling and then implement the `handleSignal` method.\n\nNow let me check the ticks client to see the available methods, especially `SetAwaiting` and `CloseTask`.\n\nI can see the ticks client already has `SetAwaiting` and `CloseTask` methods. Now let me also check the Task struct to see if it has a `Requires` field.\n\nNow I have a good understanding of the codebase. I can see:\n1. The signal types are defined in `signals.go`\n2. The ticks client has `SetAwaiting(taskID, awaiting, note)` and `CloseTask(taskID, reason)` methods\n3. The Task struct has a `Requires *string` field\n\nI notice that the ticks client already has a `CompleteTask` method (lines 309-324 in client.go) that handles the requires field check. The task says to implement `handleSignal` in the engine, so I'll add it there. The method will use `SetAwaiting` and `CloseTask` from the ticks client.\n\nLet me add the `signalToAwaiting` map and `handleSignal` method to `engine.go`. I'll add it near the signal handling code in the Run method.\n\nNow let me check the existing engine tests to understand the testing patterns used.\n\nI can see the test patterns. The tests use mock clients. I'll create tests for the `handleSignal` method that cover all the acceptance criteria:\n1. All signals mapped to correct awaiting states\n2. COMPLETE checks requires field before closing\n3. Context passed to SetAwaiting as note\n4. Unknown signals handled gracefully\n\nLet me add tests for `handleSignal` to the engine_test.go file.\n\nThe tests I added rely on the engine having a `ticks` field. Looking at the engine struct, I see it's using `*ticks.Client` directly which is not easily mockable (since it's a struct, not an interface). Let me take a different approach - I'll use the tests to verify the signalToAwaiting map is correct, and test the handleSignal method logic in a way that doesn't require a mock.\n\nLet me simplify the test file to only include tests that work without deep mocking infrastructure.\n\nNow let me run the tests to make sure everything passes.\n\nAll the new tests pass. Let me see the rest of the output to confirm all tests pass.\n\nAll tests pass. Now let me also run the full test suite to ensure I haven't broken anything else.\n\nAll tests pass. Now let me verify the implementation once more by reading the final code.\n\nNow let me close the task and commit the changes.\n\nTask t9y is complete. Here's a summary of what was implemented:\n\n## Summary\n\nAdded the `signalToAwaiting` map and `handleSignal` method to `internal/engine/engine.go`:\n\n### signalToAwaiting Map (line 737-746)\nMaps all 8 handoff signals to their corresponding awaiting states:\n- `SignalEject` → \"work\"\n- `SignalBlocked` → \"input\" (legacy backwards compat)\n- `SignalApprovalNeeded` → \"approval\"\n- `SignalInputNeeded` → \"input\"\n- `SignalReviewRequested` → \"review\"\n- `SignalContentReview` → \"content\"\n- `SignalEscalate` → \"escalation\"\n- `SignalCheckpoint` → \"checkpoint\"\n\n### handleSignal Method (line 752-774)\n- `SignalNone`: Returns nil (no-op)\n- `SignalComplete`: Checks `task.Requires` field - if set, routes to `SetAwaiting`; otherwise calls `CloseTask`\n- Other signals: Looks up awaiting state in map and calls `SetAwaiting` with context as note\n- Unknown signals: Returns nil gracefully\n\n### Tests Added\n- `TestSignalToAwaiting` - Verifies each signal maps correctly\n- `TestSignalToAwaitingMap_Completeness` - Ensures all 8 signals are in the map\n- `TestSignalToAwaitingMap_ExcludesNonHandoff` - Verifies COMPLETE/NONE not in map\n- `TestHandleSignal_RequiresFieldLogic` - Tests the requires field conditional logic",
    "tools": [
      {
        "name": "TodoWrite",
        "duration_ms": 2731
      },
      {
        "name": "Read",
        "duration_ms": 1074
      },
      {
        "name": "Read",
        "duration_ms": 182
      },
      {
        "name": "TodoWrite",
        "duration_ms": 3093
      },
      {
        "name": "Read",
        "duration_ms": 841
      },
      {
        "name": "Read",
        "duration_ms": 830
      },
      {
        "name": "TodoWrite",
        "duration_ms": 3074
      },
      {
        "name": "Edit",
        "duration_ms": 9521
      },
      {
        "name": "TodoWrite",
        "duration_ms": 1690
      },
      {
        "name": "Glob",
        "duration_ms": 360
      },
      {
        "name": "Read",
        "duration_ms": 394
      },
      {
        "name": "Edit",
        "duration_ms": 41308
      },
      {
        "name": "Edit",
        "duration_ms": 45838
      },
      {
        "name": "TodoWrite",
        "duration_ms": 3314
      },
      {
        "name": "Bash",
        "duration_ms": 978
      },
      {
        "name": "Bash",
        "duration_ms": 575
      },
      {
        "name": "Bash",
        "duration_ms": 450
      },
      {
        "name": "Read",
        "duration_ms": 736
      },
      {
        "name": "TodoWrite",
        "duration_ms": 3197
      },
      {
        "name": "Bash",
        "duration_ms": 2817
      },
      {
        "name": "Bash",
        "duration_ms": 574
      },
      {
        "name": "Bash",
        "duration_ms": 3644
      },
      {
        "name": "Bash",
        "duration_ms": 5746
      },
      {
        "name": "TodoWrite",
        "duration_ms": 1672
      }
    ],
    "metrics": {
      "input_tokens": 2,
      "output_tokens": 14404,
      "cache_read_tokens": 1779850,
      "cache_creation_tokens": 57644,
      "cost_usd": 1.6301310000000002,
      "duration_ms": 243286
    },
    "success": true,
    "num_turns": 25
  },
  "status": "closed",
  "title": "Implement signal to awaiting mapping in engine",
  "type": "task",
  "updated_at": "2026-01-14T17:37:45.965084Z"
}